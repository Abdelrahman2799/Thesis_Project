---
title: "HRV Data Exploration"
author: "Abdelrahman"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
knitr::opts_chunk$set(echo = TRUE, dev = "pdf")
```
  
```{r include=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(readr) 
library(tidyverse)
library(gridExtra)
library(writexl)
```



```{r}
hrv_wide=readxl::read_xlsx('.../hrv_wide_wide.xlsx')
```

```{r}
hrv=readxl::read_xlsx('.../hrv_data.xlsx')
```


## Exploratory analysis – observed data

### Pre vs After transformation.


Try with RMSSD first:   
 
 
```{r}
RMSSD_long = hrv_wide %>%
  select(starts_with("RMSSD_msec_T")) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Time",
    values_to = "RMSSD"
  ) %>%
  filter(!is.na(RMSSD))
```

```{r}
g=ggplot(RMSSD_long, aes(x = RMSSD)) +
  geom_histogram(bins = 30, color = "black", fill = "#6E9FC6") +
  labs(
    title = "Histogram of RMSSD_msec",
    x = "RMSSD",
    y = "Frequency"
  ) +
  theme_minimal()
ggsave(paste0('RMSSD_hist.png'), g, width = 7.5, height = 5.5, dpi = 300)
```



```{r}
lnRMSSD_long <- hrv_wide %>%
  select(starts_with("lnRMSSD_msec_T")) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Time",
    values_to = "lnRMSSD"
  ) %>%
  filter(!is.na(lnRMSSD))

```


```{r}
  g= ggplot(lnRMSSD_long, aes(x = lnRMSSD)) +
  geom_histogram(bins = 30, color = "black", fill = "#6E9FC6") +
  labs(
    title = "Histogram of lnRMSSD",
    x = "lnRMSSD",
    y = "Frequency"
  ) +
  theme_minimal()

  ggsave(paste0('lnRMSSD_hist.png'), g, width = 7.5, height = 5.5, dpi = 300)
```



```{r}
#g = 
  ggplot(lnRMSSD_long, aes(sample = lnRMSSD)) +
  stat_qq() +
  stat_qq_line() +
  labs(
    title = "QQ plot of lnRMSSD (observed values only)"
  ) +
  theme_minimal()

ggsave(paste0('lnRMSSD_preImp_QQ.png'), g, width = 7.5, height = 5.5, dpi = 300)
```
Repeat the same logic for other variables

```{r}
plot_distribution <- function(df, pattern, value_name) {
  
  long_df <- hrv_wide %>%
    select(starts_with(pattern)) %>%
    pivot_longer(
      cols = everything(),
      names_to = "Time",
      values_to = value_name
    ) %>%
    filter(!is.na(.data[[value_name]]))
  
  p1 <- ggplot(long_df, aes(x = .data[[value_name]])) +
    geom_histogram(bins = 30, color = "black", fill = "#6E9FC6") +
    theme_minimal() +
    labs(title = paste("Histogram of", value_name))
  
  p2 <- ggplot(long_df, aes(sample = .data[[value_name]])) +
    stat_qq() +
    stat_qq_line() +
    theme_minimal() +
    labs(title = paste("QQ plot of", value_name))
  
  list(histogram = p1, qqplot = p2)
}
```


```{r}
plot_distribution <- function(df, value_name, prefix, out_dir = "plots") {
  
  # Create output directory if it doesn't exist
  if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)
  
  # Remove missing values explicitly
  df_plot <- df[!is.na(df[[value_name]]), , drop = FALSE]
  
  # Histogram
  p1 <- ggplot(df_plot, aes(x = .data[[value_name]])) +
    geom_histogram(bins = 30, color = "black", fill = "#6E9FC6") +
    theme_minimal() +
    labs(
      title = paste("Histogram of", value_name),
      x = value_name,
      y = "Count"
    )
  
  # QQ plot
  p2 <- ggplot(df_plot, aes(sample = .data[[value_name]])) +
    stat_qq() +
    stat_qq_line() +
    theme_minimal() +
    labs(
      title = paste("Q–Q plot of", value_name)
    )
  
  # Save plots
  ggsave(
    filename = file.path(out_dir, paste0(prefix, "_", value_name, "_hist.png")),
    plot = p1,
    width = 6,
    height = 4,
    dpi = 300
  )
  
  ggsave(
    filename = file.path(out_dir, paste0(prefix, "_", value_name, "_qq.png")),
    plot = p2,
    width = 6,
    height = 4,
    dpi = 300
  )
  
  # Return plots (useful for inline viewing)
  return(list(histogram = p1, qqplot = p2))
}

```



```{r}
df_raw <- hrv   # your raw dataset

plot_distribution(df_raw, "RMSSD_msec", prefix = "raw")
plot_distribution(df_raw, "SDNN_msec",  prefix = "raw")
plot_distribution(df_raw, "HF_ms",      prefix = "raw")
plot_distribution(df_raw, "LF_ms",      prefix = "raw")
plot_distribution(df_raw, "LFHF",       prefix = "raw")
plot_distribution(df_raw, "Average_SCL_uS", prefix = "raw")
plot_distribution(df_raw, "RSA0_msec",  prefix = "raw")
plot_distribution(df_raw, "PEP_msec",   prefix = "raw")

```

```{r}
df_tr=readxl::read_xlsx(".../hrv_RsaSCLtransformed_long.xlsx")  

plot_distribution(df_tr, "lnRMSSD_msec",        prefix = "log")
plot_distribution(df_tr, "lnSDNN_msec",         prefix = "log")
plot_distribution(df_tr, "lnHF_ms",            prefix = "log")
plot_distribution(df_tr, "lnLF_ms",            prefix = "log")
plot_distribution(df_tr, "lnLFHF",               prefix = "log")
plot_distribution(df_tr, "lnAverage_SCL_uS",    prefix = "log")
plot_distribution(df_tr, "lnRSA0_msec",          prefix = "log")
plot_distribution(df_tr, "PEP_msec",             prefix = "raw")

```


  
### Mean exploration

```{r}
# Ensure factors are labeled (prevents linetype/color errors)
hrv <- hrv %>%
  mutate(
    Group = factor(Group, levels = c(0,1), labels = c("Low/Medium","High")),
    REST_VS_STRESS = factor(REST_VS_STRESS, levels = c(0,1), labels = c("Rest","Stress"))
  )

# Variables to explore (edit if you wish)
vars <- c("lnRMSSD_msec","lnSDNN_msec","lnHF_ms","lnLF_ms","lnLFHF","lnRSA0_msec","PEP_msec")

var_two_points <- "lnAverage_SCL_uS"

```

   

```{r}
METHOD <- "quantile"   

# central-quantile limits per variable 
ylims_quantile <- function(df, v, q = c(.25, .75), min_span = 0.05, pad = 0.02){
  xv <- df[[v]]
  lo <- as.numeric(quantile(xv, q[1], na.rm = TRUE))
  hi <- as.numeric(quantile(xv, q[2], na.rm = TRUE))
  # enforce a minimum vertical span and a small padding
  span <- max(hi - lo, min_span)
  mid  <- (hi + lo)/2
  c(mid - span/2 - pad*span, mid + span/2 + pad*span)
}

# limits using ONLY the smoothed mean range 
ylims_meanpad <- function(df, v, span = 0.75, degree = 2, pad = 0.05, min_span = 0.02){
  fit   <- loess(df[[v]] ~ df$Time, span = span, degree = degree, family = "gaussian")
  grid  <- data.frame(Time = seq(min(df$Time), max(df$Time), length.out = 200))
  pred  <- predict(fit, newdata = grid)
  rng   <- range(pred, na.rm = TRUE)
  span0 <- max(rng[2] - rng[1], min_span)
  pad0  <- pad * span0
  c(rng[1] - pad0, rng[2] + pad0)
}

pick_ylims <- function(df, v){
  if (METHOD == "meanpad") ylims_meanpad(df, v) else ylims_quantile(df, v)
}

```  

```{r}
hrv$Time = hrv$Subsequent_Observations
hrv$Time = as.factor(hrv$Time)
```


#### (a) Overall mean vs Time – observed data
```{r}
## (a) Overall distribution vs Time – observed data
## Boxplot + jitter + mean diamond

for (v in vars) {

  g <- ggplot(hrv, aes(factor(Time), .data[[v]])) +

    ## Boxplots
    geom_boxplot(
      fill = "#4E79A7",
      alpha = 0.6,
      width = 0.6,
      outlier.shape = NA
    ) +

    ## Jittered individual observations
    geom_jitter(
      width = 0.15,
      alpha = 0.25,
      size = 1,
      color = "#2F4B7C"
    ) +

    ## Mean diamond
    stat_summary(
      fun = mean,
      geom = "point",
      shape = 23,           # diamond
      size = 3.5,
      fill = "#E15759",
      color = "black"
    ) +

    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank()
    ) +

    labs(
      title = paste0("Observed distribution of ", v, " across sessions"),
      x = "Time (session)",
      y = v
    )

  ggsave(
    paste0("EDA_", v, "_Overall_Boxplot_Observed.png"),
    g,
    width = 7.5,
    height = 5.5,
    dpi = 300
  )
}


```


```{r}
## Observed lnSCL across Time 1–2 only

g <- ggplot(
  hrv %>% filter(Time %in% c(1, 2)),
  aes(factor(Time), lnAverage_SCL_uS)
) +

  ## Boxplots
  geom_boxplot(
    fill = "#4E79A7",
    alpha = 0.6,
    width = 0.6,
    outlier.shape = NA
  ) +

  ## Jittered individual observations
  geom_jitter(
    width = 0.15,
    alpha = 0.25,
    size = 1,
    color = "#2F4B7C"
  ) +

  ## Mean diamond
  stat_summary(
    fun = mean,
    geom = "point",
    shape = 23,          # diamond
    size = 3.5,
    fill = "#E15759",
    color = "black"
  ) +

  theme_bw(base_size = 13) +
  theme(
    panel.grid = element_blank()
  ) +

  labs(
    title = "Observed lnSCL across stress sessions",
    x = "Time (session)",
    y = "lnSCL"
  )

ggsave(
  "EDA_lnSCL_Time1_2_Boxplot_Observed.png",
  g,
  width = 6,
  height = 5,
  dpi = 300
)

```


#### (b) Mean vs Time × Group – observed data

```{r}
for (v in vars) {

  g <- ggplot(hrv, aes(x = factor(Time), y = .data[[v]])) +
    geom_boxplot(
      fill = "#55A868", alpha = 0.6, width = 0.6,
      outlier.alpha = 0.3
    ) +
    geom_smooth(
      aes(x = as.numeric(Time)),
      method = "loess", span = 0.75,
      color = "black", linewidth = 1.1, se = TRUE
    ) +
    facet_grid(. ~ Group) +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    ) +
    labs(
      title = paste("Observed mean trend –", v, "by Group"),
      x = "Time (session)",
      y = v
    )

  ggsave(paste0("EDA_", v, "_ByGroup_OBS.png"),
         g, width = 8, height = 5.5, dpi = 300)
}

```

```{r}
v <- "lnAverage_SCL_uS"

g <- ggplot(
  hrv %>% filter(Time %in% c(1, 2)),
  aes(factor(Time), lnAverage_SCL_uS)
) +
  geom_boxplot(
    fill = "#55A868", alpha = 0.6, width = 0.6,
    outlier.alpha = 0.3
  ) +
  geom_smooth(
    aes(x = as.numeric(Time)),
    method = "loess", span = 0.75,
    color = "black", linewidth = 1.1, se = TRUE
  ) +
  facet_grid(. ~ Group) +
  theme_bw(base_size = 13) +
  theme(
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold")
  ) +
  labs(
    title = "Observed mean trend – lnSCL by Group",
    x = "Time (session)",
    y = "lnSCL"
  )

ggsave("EDA_lnSCL_ByGroup_OBS.png",
       g, width = 8, height = 5.5, dpi = 300)

```



#### (c) Mean vs Time × Condition – observed data

```{r}
for (v in vars) {

  g <- ggplot(hrv, aes(x = factor(Time), y = .data[[v]])) +
    geom_boxplot(
      fill = "#C44E52", alpha = 0.6, width = 0.6,
      outlier.alpha = 0.3
    ) +
    geom_smooth(
      aes(x = as.numeric(Time)),
      method = "loess", span = 0.75,
      color = "black", linewidth = 1.1, se = TRUE
    ) +
    facet_grid(REST_VS_STRESS ~ .) +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    ) +
    labs(
      title = paste("Observed mean trend –", v, "by Condition"),
      x = "Time (session)",
      y = v
    )

  ggsave(paste0("EDA_", v, "_ByCondition_OBS.png"),
         g, width = 6.8, height = 6.8, dpi = 300)
}

```


#### (d) Mean vs Time × Group × Condition (2×2 panels)

```{r}
for (v in vars) {

  g <- ggplot(hrv, aes(x = factor(Time), y = .data[[v]])) +
    geom_boxplot(
      fill = "#8172B2", alpha = 0.6, width = 0.6,
      outlier.alpha = 0.3
    ) +
    geom_smooth(
      aes(x = as.numeric(Time)),
      method = "loess", span = 0.75,
      color = "black", linewidth = 1.1, se = TRUE
    ) +
    facet_grid(REST_VS_STRESS ~ Group) +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    ) +
    labs(
      title = paste("Observed mean trend –", v, "by Group × Condition"),
      x = "Time (session)",
      y = v
    )

  ggsave(paste0("EDA_", v, "_ByGroupCondition_OBS.png"),
         g, width = 8, height = 6, dpi = 300)
}

```


### Variance Exploration  

```{r}
hrv_obs <- hrv %>%
  mutate(
    Group = factor(Group, levels = c(0,1), labels = c("Low/Medium","High")),
    REST_VS_STRESS = factor(REST_VS_STRESS, levels = c(0,1), labels = c("Rest","Stress"))
  )

vars <- c("lnRMSSD_msec","lnSDNN_msec","lnHF_ms","lnLF_ms","lnLFHF","lnRSA0_msec", "PEP_msec")

```

  
```{r}
compute_sqres_obs <- function(data, var, span = 0.75) {

  if (!var %in% names(data)) {
    stop(paste("Variable not found in data:", var))
  }

  df <- data %>% filter(!is.na(.data[[var]]))
  df <- df %>%
    mutate(Time_num = as.numeric(as.character(Time)))
  
  fit <- loess(
    formula = as.formula(paste(var, "~ Time_num")),
    data = df,
    span = span,
    degree = 2
  )

  df %>%
    mutate(
      mu_hat = predict(fit, newdata = df),
      res_sq = (.data[[var]] - mu_hat)^2
    )
}

```
  
  
  
```{r}
plot_var_loess_obs <- function(data, var, title, facets = NULL) {

  p <- ggplot(data, aes(x = Time, y = res_sq)) +
    geom_point(alpha = 0.35, size = 1) +
    geom_smooth(
  aes(x = as.numeric(Time), group = 1),
  method = "loess", span = 0.75,
  color = "black", linewidth = 1.3, se = FALSE
) +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold", size = 12)
    ) +
    labs(
      title = title,
      x = "Time (session)",
      y = "Squared residuals"
    )

  if (!is.null(facets)) p <- p + facets
  return(p)
}

```

#### (a) Overall variance vs Time (observed)   

```{r}
for (v in vars) {

  df_v <- compute_sqres_obs(hrv_obs, v)

  g <- plot_var_loess_obs(
    df_v, v,
    title = paste("Observed variance trend –", v)
  )

  ggsave(paste0("VAR_", v, "_Overall_OBS.png"),
         g, width = 7.5, height = 5.5, dpi = 300)
}

```

```{r}
v <- "lnAverage_SCL_uS"

df_v <- compute_sqres_obs(hrv_obs, v)

g1 <- ggplot(df_v, aes(x = Time, y = res_sq)) +
  geom_point(alpha = 0.25, size = 1) +
  geom_smooth(
    aes(x = as.numeric(Time), group = 1),
    method = "loess", span = 0.75,
    color = "black", linewidth = 1.2, se = FALSE
  ) +
  theme_bw(base_size = 13) +
  theme(panel.grid = element_blank()) +
  labs(
    title = "Observed variance trend – lnSCL",
    x = "Time (session)",
    y = "Squared residuals"
  )

ggsave("VAR_lnSCL_Overall_OBS.png",
       g1, width = 7.5, height = 5.5, dpi = 300)

```


```{r}
hrv=readxl::read_xlsx('.../hrv_data.xlsx')

hrv$Time = hrv$Subsequent_Observations
#hrv$Time = as.factor()
```

```{r}
hrv_obs <- hrv %>%
  mutate(
    Group = factor(Group, levels = c(0,1), labels = c("Low/Medium","High")),
    REST_VS_STRESS = factor(REST_VS_STRESS, levels = c(0,1), labels = c("Rest","Stress"))
  )

vars <- c("lnRMSSD_msec","lnSDNN_msec","lnHF_ms","lnLF_ms","lnLFHF","lnRSA0_msec", "PEP_msec")
```

  
  
#### (b) Variance x Time x Group  

```{r}
for (v in vars) {

  df_v <- compute_sqres_obs(hrv_obs, v)

  g <- plot_var_loess_obs(
    df_v, v,
    title = paste("Observed variance trend by Group –", v),
    facets = facet_grid(. ~ Group)
  )

  ggsave(paste0("VAR_", v, "_ByGroup_OBS.png"),
         g, width = 8, height = 5.5, dpi = 300)
}

```
  
  
```{r}
g2 <- ggplot(df_v %>%  dplyr::filter(Time <= 2), aes(x = Time, y = res_sq)) +
  geom_point(alpha = 0.25, size = 1) +
  geom_smooth(
    aes(x = as.numeric(Time), group = 1),
    method = "loess", span = 0.75,
    color = "black", linewidth = 1.2, se = FALSE
  ) +
  facet_grid(. ~ Group) +
  theme_bw(base_size = 13) +
  theme(
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold")
  ) +
  labs(
    title = "Observed variance trend – lnSCL by Group",
    x = "Time (session)",
    y = "Squared residuals"
  )

ggsave("VAR_lnSCL_ByGroup_OBS.png",
       g2, width = 8, height = 5.5, dpi = 300)

```
  
  
#### (c) Variance x Time x Condition  

```{r}
for (v in vars) {

  df_v <- compute_sqres_obs(hrv_obs, v)

  g <- plot_var_loess_obs(
    df_v, v,
    title = paste("Observed variance trend by Condition –", v),
    facets = facet_grid(REST_VS_STRESS ~ .)
  )

  ggsave(paste0("VAR_", v, "_ByCond_OBS.png"),
         g, width = 7, height = 6, dpi = 300)
}

```

#### (d)  Variance vs Time × Group × Condition
  
```{r}
for (v in vars) {

  df_v <- compute_sqres_obs(hrv_obs, v)

  g <- plot_var_loess_obs(
    df_v, v,
    title = paste("Observed variance trend by Group × Condition –", v),
    facets = facet_grid(REST_VS_STRESS ~ Group)
  )

  ggsave(paste0("VAR_", v, "_ByGroupCond_OBS.png"),
         g, width = 8, height = 6, dpi = 300)
}

```



### Individual Profiles  

#### (a) Overall

```{r}
line_col <- "#4C72B0"   
x_scale <- scale_x_continuous(breaks = 1:6)

for (v in vars) {
  g <- ggplot(hrv_obs, aes(Time, .data[[v]], group = Subject_ID)) +
    geom_line(color = line_col, alpha = 0.3, linewidth = 0.6) +
    x_scale +
    theme_bw(base_size = 13) +
    theme(panel.grid = element_blank()) +
    labs(
      title = paste("Individual profiles –", v, "(Observed)"),
      x = "Time (session)",
      y = v
    )

  ggsave(paste0("IP_", v, "_Overall_OBS.png"),
         g, width = 7.5, height = 5.5, dpi = 300)
}


```


#### (b) x Group

```{r}
for (v in vars) {

  g <- ggplot(hrv_obs, aes(Time, .data[[v]], group = Subject_ID)) +
    geom_line(color = line_col, alpha = 0.3, linewidth = 0.6) +
    facet_grid(. ~ Group) +
    x_scale +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    ) +
    labs(
      title = paste("Individual profiles –", v, "by Group"),
      x = "Time (session)",
      y = v
    )

  ggsave(paste0("IP_", v, "_ByGroup_OBS.png"),
         g, width = 8, height = 5.5, dpi = 300)
}

```

#### (c) x Condition  


```{r}
for (v in vars) {

  g <- ggplot(hrv_obs, aes(Time, .data[[v]], group = Subject_ID)) +
    geom_line(color = line_col, alpha = 0.3, linewidth = 0.6) +
    facet_grid(REST_VS_STRESS ~ .) +
    x_scale +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    ) +
    labs(
      title = paste("Individual profiles –", v, "by Condition"),
      x = "Time (session)",
      y = v
    )

  ggsave(paste0("IP_", v, "_ByCondition_OBS.png"),
         g, width = 7, height = 6, dpi = 300)
}

```


#### (d) x Conditon x Group  
 
```{r}
for (v in vars) {

  g <- ggplot(hrv_obs, aes(Time, .data[[v]], group = Subject_ID)) +
    geom_line(color = line_col, alpha = 0.3, linewidth = 0.6) +
    facet_grid(REST_VS_STRESS ~ Group) +
    x_scale +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    ) +
    labs(
      title = paste("Individual profiles –", v, "by Group × Condition"),
      x = "Time (session)",
      y = v
    )

  ggsave(paste0("IP_", v, "_ByGroupCondition_OBS.png"),
         g, width = 8, height = 6, dpi = 300)
}

```
 
  
SCL 

```{r}
# ---- Individual profiles for lnSCL (Time filtered) ----

v <- "lnAverage_SCL_uS"

line_col <- "#4C72B0"
x_scale  <- scale_x_continuous(breaks = 1:6)

hrv_scl <- hrv_obs %>% 
  filter(Time <= 2) 

# (1) Overall individual profiles — lnSCL

g1 <- ggplot(hrv_scl, aes(Time, .data[[v]], group = Subject_ID)) +
  geom_line(color = line_col, alpha = 0.3, linewidth = 0.6) +
  x_scale +
  theme_bw(base_size = 13) +
  theme(panel.grid = element_blank()) +
  labs(
    title = "Individual profiles – lnSCL (Observed)",
    x = "Time (session)",
    y = v
  )

ggsave(
  "IP_lnSCL_Overall_OBS.png",
  g1, width = 7.5, height = 5.5, dpi = 300
)

# (2) Individual profiles × Group — lnSCL

g2 <- ggplot(hrv_scl, aes(Time, .data[[v]], group = Subject_ID)) +
  geom_line(color = line_col, alpha = 0.3, linewidth = 0.6) +
  facet_grid(. ~ Group) +
  x_scale +
  theme_bw(base_size = 13) +
  theme(
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold")
  ) +
  labs(
    title = "Individual profiles – lnSCL by Group (Observed)",
    x = "Time (session)",
    y = v
  )

ggsave(
  "IP_lnSCL_ByGroup_OBS.png",
  g2, width = 8, height = 5.5, dpi = 300
)


```

  
## Multiple Imputation Exploration 

### (a) Overall mean vs Time  
  
```{r}
var <- "lnSCL"


for (v in vars) {
    df_m <- hrv %>% 

    yL <- pick_ylims(df_m, v)

    g <- ggplot(df_m, aes(Time, .data[[v]])) +
      geom_point(alpha = 0.35, size = 1) +
      geom_smooth(method = "loess", span = 0.75, color = "black", linewidth = 1.1, se = FALSE) +
      coord_cartesian(ylim = yL) +                # <— auto limits here
      theme_bw(base_size = 13) + theme(panel.grid = element_blank()) +
      #scale_x_continuous(breaks = c(1, 2), limits = c(1, 2)) +
      labs(title = paste0("Per-imputation LOESS – ", v, "  (Imp=", m, ")"),
           subtitle = paste("y-lims:", paste(round(yL, 3), collapse = " to "),
                            "| method:", METHOD),
           x = "Time (session)", y = v)

    ggsave(paste0("EDA_", v, "_Overall_", m, ".png"), g, width = 7.5, height = 5.5, dpi = 300)
  }

```

  

  
## (b) Mean vs Time × Group  
  
Per Imputation  
  
```{r}
var <- 'lnSCL'

for (v in vars) {
  for (m in sort(unique(hrv$`_Imputation_`))) {
    df_m <- hrv %>% filter(`_Imputation_` == m)

    g <- ggplot(df_m, aes(Time, .data[[v]])) +
      geom_point(alpha = 0.35, size = 1) +
      geom_smooth(method = "loess", span = 0.75, color = "black", linewidth = 1.1, se = TRUE) +
      facet_grid(. ~ Group) +
      theme_bw(base_size = 13) + theme(panel.grid = element_blank(),
                                       strip.text = element_text(face="bold")) +
      labs(title = paste0("Per-imputation LOESS – ", v, " by Group (Imp=", m, ")"),
           x = "Time (session)", y = v)

    ggsave(paste0("EDA_", v, "_ByGroup_Imp", m, ".png"), g, width = 8, height = 5.5, dpi = 300)
  }
}

```

  

  
## (c) Mean vs Time × Condition (REST_VS_STRESS)  
  
Per Imputation  
  
```{r}
vars <- c("lnRMSSD","lnSDNN","lnHF","lnLF","lnLFHF","lnRSA","PEP_msec")
var <- 'lnSCL'

for (v in var) {
  for (m in sort(unique(hrv$`_Imputation_`))) {
    df_m <- hrv %>% filter(`_Imputation_` == m)

    g <- ggplot(df_m, aes(Time, .data[[v]])) +
      geom_point(alpha = 0.35, size = 1) +
      geom_smooth(method = "loess", span = 0.75, color = "black", linewidth = 1.1, se = TRUE) +
      facet_grid(REST_VS_STRESS ~ .) +
      theme_bw(base_size = 13) + theme(panel.grid = element_blank(),
                                       strip.text = element_text(face="bold")) +
      #scale_x_continuous(breaks = c(1, 2), limits = c(1, 2)) +
      labs(title = paste0("Per-imputation LOESS – ", v, " by Condition (Imp=", m, ")"),
           x = "Time (session)", y = v)

    ggsave(paste0("EDA_", v, "_ByCond_Imp", m, ".png"), g, width = 6.8, height = 6.8, dpi = 300)
  }
}

```

  
  
## (d) Mean vs Time × Group × Condition (your 2×2 panels)  

  
Per Imputation  
```{r}
for (v in vars) {
  for (m in sort(unique(hrv$`_Imputation_`))) {
    df_m <- hrv %>% filter(`_Imputation_` == m)

    g <- ggplot(df_m, aes(Time, .data[[v]])) +
      geom_point(alpha = 0.35, size = 1) +
      geom_smooth(method = "loess", span = 0.75, color = "black", linewidth = 1.1, se = TRUE) +
      facet_grid(REST_VS_STRESS ~ Group) +
      theme_bw(base_size = 13) +
      theme(panel.grid = element_blank(), strip.text = element_text(face="bold")) +
      labs(title = paste0("Per-imputation LOESS – ", v, " by Group × Condition (Imp=", m, ")"),
           x = "Time (session)", y = v)

    ggsave(paste0("EDA_", v, "_ByGroupCond_Imp", m, ".png"),
           g, width = 8, height = 6, dpi = 300)
  }
}

```
  




  
  
## Exploration of Variance  
    
Setup  
  
```{r}
library(tidyverse)

hrv <- hrv %>%
  mutate(
    Group = factor(Group, levels = c(0,1), labels = c("Low/Medium","High")),
    REST_VS_STRESS = factor(REST_VS_STRESS, levels = c(0,1), labels = c("Rest","Stress"))
  )

vars <- c("lnRMSSD","lnSDNN","lnHF","lnLF","lnLFHF","lnRSA","lnSCL","PEP_msec")
```

```{r}
hrv %>% group_by(hrv$`_Imputation_`) %>% select(PEP_msec) %>%summarise(var(PEP_msec))
```
```{r}
help(dplyr)
```

  
  
Step 1 — Helper function to compute squared residuals    

```{r}
compute_sqres <- function(data, var, span = 0.75) {
  v <- data[[var]]

  # fit LOESS mean for this imputation & variable
  fit <- loess(v ~ Time, data = data, span = span, degree = 2)

  # residuals
  data$mu_hat <- predict(fit, newdata = data)
  data$res_sq <- (v - data$mu_hat)^2

  return(data)
}

```

  
Step 2 — LOESS plotting function for squared residuals  
  
```{r}
plot_var_loess <- function(data, var, title_prefix = "", facets = NULL) {

  p <- ggplot(data, aes(x = Time, y = res_sq)) +
    geom_point(alpha = 0.3, size = 1) +
    geom_smooth(method = "loess", span = 0.75, color = "black", linewidth = 1.1) +
    theme_bw(base_size = 13) +
    theme(panel.grid = element_blank(),
          strip.text = element_text(face="bold", size=12)) +
    labs(
      title = paste0(title_prefix, var),
      x = "Time (session)",
      y = "Squared residuals"
    )

  if (!is.null(facets)) {
    p <- p + facets
  }

  return(p)
}

```

   
### 3.1 OVERALL variance vs Time
  
  
(a) Per imputation  
  
```{r}
for (v in vars) {
  for (m in sort(unique(hrv$`_Imputation_`))) {

    df_m <- hrv %>% filter(`_Imputation_` == m)
    df_m <- compute_sqres(df_m, v)

    g <- plot_var_loess(df_m, v,
            title_prefix = paste0("Variance LOESS (Imp=", m, ") – "))

    ggsave(paste0("VAR_", v, "_Overall_Imp", m, ".png"),
           g, width = 7.5, height = 5.5, dpi = 300)
  }
}
```
  
  

    
    
    
## Variance vs Time × Group
```{r}
hrv <- hrv %>%
  mutate(
    Group = dplyr::case_when(
      Group == 0 ~ "Low/Medium",
      Group == 1 ~ "High",
      TRUE       ~ NA_character_
    ),
    Group = factor(Group, levels = c("Low/Medium","High"))
  )

table(hrv$Group, useNA = "ifany")

```



(a) Per imputation  
  
```{r}
library(dplyr)
library(ggplot2)
library(purrr)

compute_sqres_all_imps <- function(data, var, span = 0.75) {
  # data: full hrv (all imputations)
  # var:  character, e.g. "lnRMSSD"
  
  data %>%
    group_by(`_Imputation_`) %>%
    group_modify(~ {
      y  <- .x[[var]]
      fit <- loess(y ~ Time, data = .x, span = span, degree = 2)
      mu_hat <- predict(fit, newdata = .x)
      
      .x %>%
        mutate(
          Variable = var,
          mu_hat   = mu_hat,
          res_sq   = (y - mu_hat)^2
        )
    }) %>%
    ungroup()
}
```
  
```{r}
vars <- c("lnRMSSD","lnSDNN","lnHF","lnLF","lnLFHF","lnRSA","PEP_msec")

var <- "lnSCL"

for (v in vars) {
  sqres_v <- compute_sqres_all_imps(hrv, v)

  for (m in sort(unique(sqres_v$`_Imputation_`))) {
    df_m <- sqres_v %>% filter(`_Imputation_` == m)

    g <- ggplot(df_m, aes(x = Time, y = res_sq)) +
      geom_point(alpha = 0.3, size = 1) +
      geom_smooth(method = "loess", span = 0.75,
                  color = "black", linewidth = 1.1) +
      facet_grid(. ~ Group) +
      theme_bw(base_size = 13) +
      #scale_x_continuous(breaks = c(1, 2), limits = c(1, 2)) +
      theme(panel.grid = element_blank(),
            strip.text = element_text(face = "bold", size = 12)) +
      labs(title = paste0("Variance LOESS by Group (Imp=", m, ") – ", v),
           x = "Time (session)",
           y = "Squared residuals")

    ggsave(paste0("VAR_", v, "_ByGroup_Imp", m, ".png"),
           g, width = 8, height = 5.5, dpi = 300)
  }
}

```

  

  
## Variance vs Time × Condition


(a) Per imputation
    
    
```{r}
vars <- c("lnRMSSD","lnSDNN","lnHF","lnLF","lnLFHF","lnRSA","PEP_msec")

var <- "lnSCL"

for (v in var) {
  for (m in unique(hrv$`_Imputation_`)) {
    df_m <- hrv %>% filter(`_Imputation_` == m)
    df_m <- compute_sqres(df_m, v)

    
    
    g <- plot_var_loess(
          df_m, v,
          title_prefix = paste0("Variance LOESS by Condition (Imp=", m, ") – "),
          facets = facet_grid(REST_VS_STRESS ~ .)
        )

    ggsave(paste0("VAR_", v, "_ByCond_Imp", m, ".png"),
           g, width = 7, height = 6, dpi = 300)
  }
}

```

  
## Variance vs Time × Group × Condition
(a) Per imputation  
  
```{r}

var <- 'lnSCL'
for (v in var) {
  for (m in unique(hrv$`_Imputation_`)) {
    df_m <- hrv %>% filter(`_Imputation_` == m)
    df_m <- compute_sqres(df_m, v)
    
    g <- ggplot(df_m, aes(x = Time, y = res_sq)) +
      geom_point(alpha = 0.3, size = 1) +
      geom_smooth(method = "loess", span = 0.75,
                  color = "black", linewidth = 1.1) +
      facet_grid(REST_VS_STRESS ~ Group) +
      theme_bw(base_size = 13) +
      scale_x_continuous(breaks = c(1, 2), limits = c(1, 2)) +
      theme(panel.grid = element_blank(),
            strip.text = element_text(face = "bold", size = 12)) +
      labs(title = paste0("Variance LOESS by Group × Condition (Imp=", m, ") – ", v),
           x = "Time (session)",
           y = "Squared residuals")

    ggsave(paste0("VAR_", v, "_ByGroupCond_Imp", m, ".png"),
           g, width = 8, height = 6, dpi = 300)
  


  }
}

```



  
## Correlation  
SAS  
   
   

## Individual Profiles  
  
Setup  

```{r}
library(dplyr)
library(ggplot2)

# Make sure factors are labeled
hrv <- hrv %>%
  mutate(
    Group = factor(Group, levels = c(0,1), labels = c("Low/Medium","High")),
    REST_VS_STRESS = factor(REST_VS_STRESS, levels = c(0,1), labels = c("Rest","Stress"))
  )

vars <- c("lnRMSSD","lnSDNN","lnRSA","PEP_msec")

irr_vars <- c('lnHF', 'lnLF', 'lnLFHF')
var <- 'lnSCL'
imps <- sort(unique(hrv$`_Imputation_`))

```
    


Helper: plot individual profiles for one variable      
  
```{r}
plot_profiles_overall_mean <- function(data, var) {
  mean_df <- data %>%
    group_by(Time) %>%
    summarise(mean_y = mean(.data[[var]], na.rm = TRUE), .groups = "drop")

  ggplot(data, aes(x = Time, y = .data[[var]], group = Subject_ID)) +
    geom_line(alpha = 0.25) +
    geom_line(data = mean_df,
              aes(x = Time, y = mean_y, group = NULL),
              color = "red", linewidth = 1.1) +
    theme_bw(base_size = 13) +
    scale_x_continuous(breaks = c(1, 2), limits = c(1, 2)) +
    theme(panel.grid = element_blank()) +
    labs(
      title = paste0("Individual profiles with mean – ", var,
                     " (Imp = ", unique(data$`_Imputation_`), ")"),
      x = "Time (session)",
      y = var
    )
}
```
    
  
```{r}
for (m in imps) {
  hrv_imp <- hrv %>% filter(`_Imputation_` == m)

  for (v in var) {
    g <- plot_profiles_overall_mean(hrv_imp, v)
    ggsave(paste0("IP_", v, "_Overall_Imp", m, ".png"),
           g, width = 7.5, height = 5.5, dpi = 300)
  }
}
```

  

  
### Profiles by Group    
  
```{r}
plot_profiles_by_group <- function(data, var) {
  mean_df <- data %>%
    group_by(Group, Time) %>%
    summarise(mean_y = mean(.data[[var]], na.rm = TRUE), .groups = "drop")

  ggplot(data, aes(x = Time, y = .data[[var]], group = Subject_ID)) +
    geom_line(alpha = 0.25) +
    geom_line(data = mean_df,
              aes(x = Time, y = mean_y, group = NULL),
              color = "red", linewidth = 1.1) +
    facet_grid(. ~ Group) +
    scale_x_continuous(breaks = c(1, 2), limits = c(1, 2)) +
    theme_bw(base_size = 13) +
    theme(panel.grid = element_blank(),
          strip.text = element_text(face = "bold")) +
    labs(
      title = paste0("Individual profiles by Group – ", var,
                     " (Imp = ", unique(data$`_Imputation_`), ")"),
      x = "Time (session)",
      y = var
    )
}

```
    
    
```{r}
for (m in imps) {
  hrv_imp <- hrv %>% filter(`_Imputation_` == m)

  for (v in var) {
    g <- plot_profiles_by_group(hrv_imp, v)
    ggsave(paste0("IP_", v, "_ByGroup_Imp", m, ".png"),
           g, width = 8, height = 5.5, dpi = 300)
  }
}

```
  
      
  
### Profiles by Condition (REST vs STRESS)  
  
```{r}
plot_profiles_by_cond <- function(data, var) {
  mean_df <- data %>%
    group_by(REST_VS_STRESS, Time) %>%
    summarise(mean_y = mean(.data[[var]], na.rm = TRUE), .groups = "drop")

  ggplot(data, aes(x = Time, y = .data[[var]], group = Subject_ID)) +
    geom_line(alpha = 0.25) +
    geom_line(data = mean_df,
              aes(x = Time, y = mean_y, group = NULL),
              color = "red", linewidth = 1.1) +
    facet_grid(REST_VS_STRESS ~ .) +
    theme_bw(base_size = 13) +
    scale_x_continuous(breaks = c(1, 2), limits = c(1, 2)) +
    theme(panel.grid = element_blank(),
          strip.text = element_text(face = "bold")) +
    labs(
      title = paste0("Individual profiles by Condition – ", var,
                     " (Imp = ", unique(data$`_Imputation_`), ")"),
      x = "Time (session)",
      y = var
    )
}
```
    
```{r}
hrv %>% group_by(hrv$`_Imputation_`) %>% select(Subject_ID, lnSCL, Time, REST_VS_STRESS) %>% filter(!is.na(lnSCL))
```

    
    
    
```{r}
for (m in imps) {
  hrv_imp <- hrv %>% filter(`_Imputation_` == m)

  for (v in var) {
    g <- plot_profiles_by_cond(hrv_imp, v)
    ggsave(paste0("IP_", v, "_ByCond_Imp", m, ".png"),
           g, width = 7, height = 6, dpi = 300)
  }
}
```

   
### Profiles by Group × Condition  
  
```{r}
plot_profiles_by_group_cond <- function(data, var) {
  mean_df <- data %>%
    group_by(Group, REST_VS_STRESS, Time) %>%
    summarise(mean_y = mean(.data[[var]], na.rm = TRUE), .groups = "drop")

  ggplot(data, aes(x = Time, y = .data[[var]], group = Subject_ID)) +
    geom_line(alpha = 0.25) +
    geom_line(data = mean_df,
              aes(x = Time, y = mean_y, group = NULL),
              color = "red", linewidth = 1.1) +
    facet_grid(REST_VS_STRESS ~ Group) +
    theme_bw(base_size = 13) +
    scale_x_continuous(breaks = c(1, 2), limits = c(1, 2)) +
    theme(panel.grid = element_blank(),
          strip.text = element_text(face = "bold")) +
    labs(
      title = paste0("Individual profiles by Group × Condition – ", var,
                     " (Imp = ", unique(data$`_Imputation_`), ")"),
      x = "Time (session)",
      y = var
    )
}
```


```{r}
hrv %>%
  filter(!is.na(lnSCL)) %>%
  count(REST_VS_STRESS, Group, Time)

```


  
```{r}
for (m in imps) {
  hrv_imp <- hrv %>% filter(`_Imputation_` == m)

  for (v in var) {
    g <- plot_profiles_by_group_cond(hrv_imp, v)
    ggsave(paste0("IP_", v, "_ByGroupCond_Imp", m, ".png"),
           g, width = 8, height = 6, dpi = 300)
  }
}

```







```{r}
vars_partial <- c("lnHF", "lnLF", "lnLFHF")
```


```{r}
plot_profiles_overall_mean_partial <- function(data, var) {
  df <- data %>%
    filter(!is.na(.data[[var]]),
           Time %in% c(1, 3, 4, 6))   # only times where HF/LF/LFHF exist

  mean_df <- df %>%
    group_by(Time) %>%
    summarise(mean_y = mean(.data[[var]], na.rm = TRUE), .groups = "drop")

  ggplot(df, aes(x = Time, y = .data[[var]], group = Subject_ID)) +
    geom_line(alpha = 0.25) +
    geom_line(data = mean_df,
              aes(x = Time, y = mean_y, group = NULL),
              color = "red", linewidth = 1.1) +
    theme_bw(base_size = 13) +
    theme(panel.grid = element_blank()) +
    scale_x_continuous(
      breaks = c(1, 3, 4, 6),
      limits = c(1, 6)
    ) +
    labs(
      title = paste0("Individual profiles with mean – ", var,
                     " (Imp = ", paste(unique(df$`_Imputation_`), collapse = ","), ")"),
      x = "Time (session)",
      y = var
    )
}

```



```{r}
for (m in imps) {
  hrv_imp <- hrv %>% filter(`_Imputation_` == m)

  for (v in vars_partial) {
    g <- plot_profiles_overall_mean_partial(hrv_imp, v)
    ggsave(paste0("IP_", v, "_Overall_Imp", m, ".png"),
           g, width = 7.5, height = 5.5, dpi = 300)
  }
}

```





```{r}
plot_profiles_by_group_cond_partial <- function(data, var) {
  df <- data %>%
    filter(!is.na(.data[[var]]),
           Time %in% c(1, 3, 4, 6))

  mean_df <- df %>%
    group_by(Group, REST_VS_STRESS, Time) %>%
    summarise(mean_y = mean(.data[[var]], na.rm = TRUE), .groups = "drop")

  ggplot(df, aes(x = Time, y = .data[[var]], group = Subject_ID)) +
    geom_line(alpha = 0.25) +
    geom_line(data = mean_df,
              aes(x = Time, y = mean_y, group = NULL),
              color = "red", linewidth = 1.1) +
    facet_grid(REST_VS_STRESS ~ Group) +
    theme_bw(base_size = 13) +
    theme(panel.grid = element_blank(),
          strip.text = element_text(face = "bold")) +
    scale_x_continuous(
      breaks = c(1, 3, 4, 6),
      limits = c(1, 6)
    ) +
    labs(
      title = paste0("Individual profiles by Group × Condition – ", var,
                     " (Imp = ", paste(unique(df$`_Imputation_`), collapse = ","), ")"),
      x = "Time (session)",
      y = var
    )
}

```


```{r}
for (m in imps) {
  hrv_imp <- hrv %>% filter(`_Imputation_` == m)

  for (v in vars_partial) {
    g <- plot_profiles_by_group_cond_partial(hrv_imp, v)
    ggsave(paste0("IP_", v, "_ByGroupCond_Imp", m, ".png"),
           g, width = 8, height = 6, dpi = 300)
  }
}

```





```{r}
plot_profiles_by_group_partial <- function(data, var) {
  df <- data %>%
    filter(!is.na(.data[[var]]),
           Time %in% c(1, 3, 4, 6))

  mean_df <- df %>%
    group_by(Group, Time) %>%
    summarise(mean_y = mean(.data[[var]], na.rm = TRUE), .groups = "drop")

  ggplot(df, aes(x = Time, y = .data[[var]], group = Subject_ID)) +
    geom_line(alpha = 0.25) +
    geom_line(data = mean_df,
              aes(x = Time, y = mean_y, group = NULL),
              color = "red", linewidth = 1.1) +
    facet_grid(. ~ Group) +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    ) +
    scale_x_continuous(
      breaks = c(1, 3, 4, 6),
      limits = c(1, 6)
    ) +
    labs(
      title = paste0("Individual profiles by Group – ", var,
                     " (Imp = ", paste(unique(df$`_Imputation_`), collapse = ","), ")"),
      x = "Time (session)",
      y = var
    )
}

```


```{r}
for (m in imps) {
  hrv_imp <- hrv %>% filter(`_Imputation_` == m)

  for (v in vars_partial) {
    g <- plot_profiles_by_group_partial(hrv_imp, v)
    ggsave(paste0("IP_", v, "_ByGroup_Imp", m, ".png"),
           g, width = 8, height = 5.5, dpi = 300)
  }
}

```



```{r}
plot_profiles_by_cond_partial <- function(data, var) {
  df <- data %>%
    filter(!is.na(.data[[var]]),
           Time %in% c(1, 3, 4, 6))

  mean_df <- df %>%
    group_by(REST_VS_STRESS, Time) %>%
    summarise(mean_y = mean(.data[[var]], na.rm = TRUE), .groups = "drop")

  ggplot(df, aes(x = Time, y = .data[[var]], group = Subject_ID)) +
    geom_line(alpha = 0.25) +
    geom_line(data = mean_df,
              aes(x = Time, y = mean_y, group = NULL),
              color = "red", linewidth = 1.1) +
    facet_grid(REST_VS_STRESS ~ .) +
    theme_bw(base_size = 13) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    ) +
    scale_x_continuous(
      breaks = c(1, 3, 4, 6),
      limits = c(1, 6)
    ) +
    labs(
      title = paste0("Individual profiles by Condition – ", var,
                     " (Imp = ", paste(unique(df$`_Imputation_`), collapse = ","), ")"),
      x = "Time (session)",
      y = var
    )
}

```


```{r}
for (m in imps) {
  hrv_imp <- hrv %>% filter(`_Imputation_` == m)

  for (v in vars_partial) {
    g <- plot_profiles_by_cond_partial(hrv_imp, v)
    ggsave(paste0("IP_", v, "_ByCond_Imp", m, ".png"),
           g, width = 7, height = 6, dpi = 300)
  }
}

```


